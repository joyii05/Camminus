/*
 * File: app/controller/Menu.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Camminus.controller.Menu', {
    extend: 'Ext.app.Controller',

    models: [
        'menu.Item',
        'menu.Root'
    ],
    stores: [
        'Menu'
    ],
    views: [
        'menu.Accordion',
        'menu.Item'
    ],

    refs: [
        {
            ref: 'mainPanel',
            selector: 'mainpanel'
        },
        {
            ref: 'costumersForm',
            selector: 'costumersform'
        },
        {
            ref: 'casesForm',
            selector: 'casesform'
        },
        {
            ref: 'companiesForm',
            selector: 'companiesform'
        }
    ],

    onPanelRender: function(component, eOpts) {
        this.getMenuStore().load(function(records, op, success){

            var menuPanel = Ext.ComponentQuery.query('mainmenu')[0];

            Ext.each(records, function(root){


                var menu = Ext.create('Camminus.view.menu.Item',{
                    title: root.get('text'),
                    iconCls: root.get('iconCls')
                });

                if(root.items().data.length===2){
                    menu.maxHeight = 90;
                }
                    else if(root.items().data.length===3){
                         menu.maxHeight = 115;
                    }
                        else if(root.items().data.length===4){
                             menu.maxHeight = 145;
                        }
                            else{
                                menu.maxHeight = 160;
                            }

                if (root.get('text')==="Profile"){
                    menu.setTitle(UserData.getName());
                }



                Ext.each(root.items(), function(itens){

                    Ext.each(itens.data.items, function(item){

                        menu.getRootNode().appendChild({
                            text: item.get('text'),
                            leaf: true,
                            iconCls: item.get('iconCls'),
                            id: item.get('id'),
                            className: item.get('className'),
                            classType: item.get('classType')
                        });
                    });
                });

                menuPanel.add(menu);
            });
        });
    },

    onTreepanelItemClick: function(dataview, record, item, index, e, eOpts) {

        if (record.raw.classType === 'panel'){


            var mainPanel = this.getMainPanel();

            var newTab = mainPanel.items.findBy(
                function (tab){
                    return tab.title === record.get('text');
                });


            if (!newTab){
                newTab = mainPanel.add({
                    xtype: record.raw.className,
                    closable: true,
                    iconCls: record.get('iconCls') + '-blue',
                    title: record.get('text')
                });
            }

            mainPanel.setActiveTab(newTab);

        }

        if(record.raw.classType === 'window'){

            if(record.raw.className === 'costumersform'){

                var win    = this.getCostumersForm(),
                    record = Ext.create('Camminus.model.Costumer');


                if(!win){
                    win = Ext.widget('costumersform');
                }

                win.adding = true;

                win.down('form').loadRecord(record);

                win.show();

            }

            else if(record.raw.className === 'casesform'){

                var win    = this.getCasesForm();
               //     record = Ext.create('Camminus.model.Case');


                if(!win){
                    win = Ext.widget('casesform');
                }

                win.adding = true;

               // win.down('form').loadRecord(record);

                win.show();

            }

        }
    },

    init: function(application) {
        this.control({
            "mainmenu": {
                render: this.onPanelRender
            },
            "mainmenuitem": {
                itemclick: this.onTreepanelItemClick
            }
        });
    }

});
